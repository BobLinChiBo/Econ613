library(tidyverse)
library(ggplot2)
library(scales)
library(sampleSelection)
library(AER)
library(plm)
options(scipen=10, digit=20)
##### Exercise 4
raw_panel <-
read_csv("./Data/dat_A4_panel.csv",
col_types = cols(.default = "d")) %>%
select(!starts_with("..."))
panel <- raw_panel %>%
rename(birth_year = KEY_BDATE_Y_1997,
gender = KEY_SEX_1997,
race = KEY_RACE_ETHNICITY_1997) %>%
rename_with(~ str_replace(., "YINC-1700", "my_income_y")) %>%
rename_with(~ str_replace(., "CV_MARSTAT_COLLAPSED", "marital_status_y")) %>%
select(!contains("EVER_EDT")) %>%
rename_with(~ str_replace(., "CV_HIGHEST_DEGREE_.+?_", "self_edu_degree_y_")) %>%
mutate(age = 2019 - birth_year,
gender = factor(gender, labels = c("male", "female")),
race = factor(race, labels = c("black", "hispanic", "mixed", "non")),
across(starts_with("marital_status"), function(x) x == 1, .names = "my_married_{.col}"),
across(starts_with("self_edu_degree"), function(x) case_when(x == 1 ~ 0,
x == 2 ~ 12,
x == 3 ~ 12,
x == 4 ~ 14,
x == 5 ~ 16,
x == 6 ~ 18,
x == 7 ~ 23,
x == 8 ~ 19,
x <= 0 ~ NA_real_), .names = "my_edu_{.col}"))
### Q2
panel_long <- panel %>%
pivot_longer(starts_with("my_"), names_to = c(".value", "year"), names_sep = "_y_") %>%
rename(id = PUBID_1997,
education  = my_edu_self_edu_degree,
income = my_income,
married = my_married_marital_status) %>%
select(id, year, gender, income, education, married) %>%
drop_na()
# between
between_data <- panel_long %>%
group_by(id) %>% summarise(gender = mean(as.numeric(gender)),
mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)))
between_lm <- lm(mean_income ~ gender + mean_education + mean_married , data = between_data)
# between
between_data <- panel_long %>%
group_by(id) %>% summarise(gender = mean(as.numeric(gender)),
mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education))
between_lm <- lm(mean_income ~ gender + mean_education + mean_married , data = between_data)
summary(between_lm)
between_plm <- plm(income ~  gender + education + married, data = panel_long, model = "between")
summary(between_plm)
?plm
between_plm <- plm(income ~  gender + education + married, data = panel_long, model = "between", effect = "individual", index = id)
between_plm <- plm(income ~  gender + education + married, data = panel_long, model = "between", index = id)
between_plm <- plm(income ~  gender + education + married, data = panel_long, model = "between", index = "id")
summary(between_plm)
summary(between_lm)
between_plm <- plm(income ~  gender + education + married, data = panel_long, model = "between", effect = "individual", index = "id")
summary(between_plm)
panel_plm <- pdata.frame(panel_long, index = c("id", "year"))
between_plm <- plm(income ~  gender + education + married, data = panel_plm, model = "between")
summary(between_plm)
summary(between_lm)
between(panel_long$income)
between(panel_plm$income)
a <- between(panel_plm$income)
View(between_data)
head(between(panel_plm$education))
head(between(panel_plm$married))
# between
between_data <- panel_long %>%
group_by(id) %>% summarise(gender = mean(as.numeric(gender)-1),
mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education))
between_lm <- lm(mean_income ~ gender + mean_education + mean_married , data = between_data)
summary(between_lm)
panel_plm <- pdata.frame(panel_long, index = c("id", "year"))
between_plm <- plm(income ~  gender + education + married, data = panel_plm, model = "between")
summary(between_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = income - mean_education,
dif_married = income - mean_married)
View(within_data)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married)
within_lm <- lm(dif_income ~ dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
summary(within_plm)
?lm
install.packages("miceadds")
library(miceadds
)
?lm.cluster
lm.cluster(within_data, dif_income ~ -1 + dif_education + dif_married, cluster = "id")
summary(lm.cluster(within_data, dif_income ~ -1 + dif_education + dif_married, cluster = "id"))
summary(within_plm)
summary(within_lm)
?plm
View(within_data)
within_lm <- lm(dif_income ~ -1 + dif_education , data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education , data = panel_plm, model = "within")
summary(within_plm)
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_educatio_fail = sum(dif_educatio_check) == 0,
dif_married_fail = sum(dif_married_check) == 0)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0)
View(within_data)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!dif_income_fail)
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!dif_income_fail & !dif_education_fail & !dif_married_fail)
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!dif_education_fail & !dif_married_fail)
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
within(panel_plm$income)
Within(panel_plm$income)
head(Within(panel_plm$income))
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married)
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
head(Within(panel_plm$income))
length(Within(panel_plm$income))
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(count = n())
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(count = n()) %>%
filter(count > 1)
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
summary(lm(Within(panel_plm$income) ~ Within(panel_plm$education)))
summary(lm(Within(panel_plm$income) ~ Within(panel_plm$education) + Within(panel_plm$married)))
summary(lm(Within(panel_plm$income) ~ -1 + Within(panel_plm$education) + Within(panel_plm$married)))
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!(dif_education_fail & dif_married_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!(dif_education_fail & dif_married_fail & dif_income_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!(dif_education_fail & dif_married_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!(dif_married_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!(dif_education_fail & dif_married_fail & dif_income_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!(dif_education_fail & dif_married_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!(dif_education_fail & dif_income_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!( dif_married_fail & dif_income_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!(dif_education_fail & dif_married_fail & dif_income_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!dif_income_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!dif_income_fail)
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
# within
within_data <- panel_long %>%
group_by(id) %>%
mutate(mean_married = mean(married),
mean_income = mean(income),
mean_education = mean(education)) %>%
mutate(dif_income = income - mean_income,
dif_education = education - mean_education,
dif_married = married - mean_married) %>%
mutate(dif_income_check = dif_income != 0,
dif_education_check = dif_education != 0,
dif_married_check = dif_married != 0) %>%
mutate(dif_income_fail = sum(dif_income_check) == 0,
dif_education_fail = sum(dif_education_check) == 0,
dif_married_fail = sum(dif_married_check) == 0) %>%
filter(!dif_income_fail) %>%
filter(!(dif_education_fail & dif_married_fail))
within_lm <- lm(dif_income ~ -1 + dif_education + dif_married, data = within_data)
summary(within_lm)
within_plm <- plm(income ~  education + married, data = panel_plm, model = "within")
summary(within_plm)
is.na(Within(panel_plm$income))
Within(panel_plm$income)[is.na(Within(panel_plm$income))]
Within(panel_plm$married)[is.na(Within(panel_plm$married))]
Within(panel_plm$education)[is.na(Within(panel_plm$education))]
Within(panel_plm$education)[(Within(panel_plm$education)) == 0]
